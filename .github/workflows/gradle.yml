name: Java CI with Gradle

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # CodeCoverage.md 업데이트를 위해 write 권한 필요

    steps:
    # Checkout the repository
    - uses: actions/checkout@v4

    # Set up JDK 17
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    # gradlew 실행 권한 설정 (권한이 없으면 설정하고, 이미 권한이 있으면 무시)
    - name: Give Gradle Wrapper execute permission
      run: chmod +x gradlew || echo "gradlew is already executable"

    # Cache Gradle dependencies
    - name: Cache Gradle dependencies
      uses: actions/cache@v3
      with:
        path: ~/.gradle/caches
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    # Set up Gradle
    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v4

    # Run tests and generate Jacoco report
    - name: Run Tests with Coverage
      run: ./gradlew clean test jacocoTestReport

    # Check Jacoco coverage
    - name: Extract Jacoco Coverage
      id: coverage
      run: |
        # Jacoco XML 파일에서 커버리지 값을 추출
        COVERAGE=$(grep -oP '(?<=<counter type="INSTRUCTION" missed="[0-9]+" covered="[0-9]+").*?covered="[0-9]+"' build/reports/jacoco/test/jacocoTestReport.xml | awk -F'"' '{print $4}' | head -n 1)
    
        # 커버리지 값이 비어있는지 확인하고, 비어있으면 0으로 설정
        if [ -z "$COVERAGE" ]; then
          COVERAGE=0
        fi

        echo "COVERAGE=${COVERAGE}" >> $GITHUB_ENV
        echo "Code Coverage: $COVERAGE%"  # Optional log for debugging
    #=================

    # Update CodeCoverage.md with coverage percentage
    - name: Update CodeCoverage.md
      run: |
        echo "# Code Coverage" > CodeCoverage.md
        echo "Current Code Coverage: ${COVERAGE}%" >> CodeCoverage.md
        echo "Generated by GitHub Actions on $(date)" >> CodeCoverage.md

    # Commit gradlew permission change and CodeCoverage.md update
    - name: Commit gradlew permissions and CodeCoverage.md update
      if: github.ref == 'refs/heads/main'
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        git add gradlew CodeCoverage.md
        git commit -m "Fix gradlew permissions and update CodeCoverage.md with code coverage: ${COVERAGE}%"
        git push
