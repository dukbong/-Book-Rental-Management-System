name: Java CI with Gradle

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # README 업데이트를 위해 write 권한 필요

    steps:
    # Checkout the repository
    - uses: actions/checkout@v4

    # Set up JDK 17
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    # gradlew 실행 권한 설정 (이미 권한이 설정되어 있을 수 있으므로 이를 무시)
    - name: Give Gradle Wrapper execute permission
      run: chmod +x gradlew || echo "gradlew is already executable"

    # Cache Gradle dependencies
    - name: Cache Gradle dependencies
      uses: actions/cache@v3
      with:
        path: ~/.gradle/caches
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    # Set up Gradle
    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v4

    # Run tests and generate Jacoco report
    - name: Run Tests with Coverage
      run: ./gradlew clean test jacocoTestReport

    # Check Jacoco coverage
    - name: Extract Jacoco Coverage
      id: coverage
      run: |
        COVERAGE=$(grep -oP '(?<=<counter type="INSTRUCTION" missed="[0-9]+" covered="[0-9]+").*?covered="[0-9]+"' build/reports/jacoco/test/jacocoTestReport.xml | awk -F'"' '{print $4}')
        echo "COVERAGE=${COVERAGE}" >> $GITHUB_ENV
        echo "Code Coverage: $COVERAGE%"  # Optional log for debugging

    # Update README with coverage percentage
    - name: Update README
      run: |
        sed -i "s/Code Coverage: .*%/Code Coverage: ${COVERAGE}%/" README.md

    # Commit README update with code coverage
    - name: Commit README Update
      if: github.ref == 'refs/heads/main'
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        git add README.md
        git commit -m "Update README with code coverage: ${COVERAGE}%"
        git push
